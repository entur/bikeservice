version: 2.1

executors:
  java-11:
    docker:
      - image: circleci/openjdk:11-jdk

orbs:
  gradle: circleci/gradle@2.1.0
  docker: circleci/docker@1.0.1
  owasp: entur/owasp@0.0.10
  slack: circleci/slack@3.4.2

jobs:
  build:
    executor: java-11
    steps:
      - checkout
      - gradle/with_cache:
          steps:
            - run: ./gradlew --no-daemon clean build
      - persist_to_workspace:
          root: .
          paths:
            - build/libs/

  slack_it:
    owasp/owasp_dependency_check:
    executor: java-11
    steps:
      - slack/status:
          fail_only: false
          failure_message: "Docker image cotains unapproved vulnerabilities"
          webhook: '${SLACK_WEBHOOK}'

workflows:
  Build-Publish:
    jobs:
      - build
      - docker/publish:
          name: release
          registry: $DOCKER_REGISTRY
          image: $CIRCLE_PROJECT_REPONAME
          tag: $VERSION
          deploy: true
          context: global
          after_checkout:
            - attach_workspace:
                at: .
          before_build:
            - checkout
            - run: echo "export VERSION=$(echo ${CIRCLE_BRANCH}-$(date '+%Y-%m-%d-%H%M')-${CIRCLE_SHA1:0:7}-${CIRCLE_WORKFLOW_ID:0:4} | tr '/' '.' )" >> $BASH_ENV
            - run:
                name: Tag git commit with build version and push to github
                command: |
                  git config --global push.default simple
                  git config --global user.email "circleci@entur.no"
                  git config --global user.name "circleci"
                  echo $VERSION
                  git tag $VERSION
                  git push origin $VERSION
          requires:

      - slack_it